"use strict";
var __createBinding = (this && this.__createBinding) || (Object.create ? (function(o, m, k, k2) {
    if (k2 === undefined) k2 = k;
    Object.defineProperty(o, k2, { enumerable: true, get: function() { return m[k]; } });
}) : (function(o, m, k, k2) {
    if (k2 === undefined) k2 = k;
    o[k2] = m[k];
}));
var __setModuleDefault = (this && this.__setModuleDefault) || (Object.create ? (function(o, v) {
    Object.defineProperty(o, "default", { enumerable: true, value: v });
}) : function(o, v) {
    o["default"] = v;
});
var __importStar = (this && this.__importStar) || function (mod) {
    if (mod && mod.__esModule) return mod;
    var result = {};
    if (mod != null) for (var k in mod) if (k !== "default" && Object.prototype.hasOwnProperty.call(mod, k)) __createBinding(result, mod, k);
    __setModuleDefault(result, mod);
    return result;
};
Object.defineProperty(exports, "__esModule", { value: true });
exports.PullRequestLabelManager = void 0;
const core = __importStar(require("@actions/core"));
const github = __importStar(require("@actions/github"));
class PullRequestLabelManager {
    constructor(token, options) {
        this.client = github.getOctokit(token);
        this.repo = github.context.repo.repo;
        this.owner = github.context.repo.owner;
        this.priorityLabels = options.priorityLabels ?? ['p0', 'p1', 'p2'];
        this.classificationLabels = options.classificationLabels ?? ['bug', 'feature-request'];
        this.effortLabels = options.effortLabels ?? ['effort-large', 'effort-medium', 'effort-small'];
        this.dryRun = options.dryRun ?? false;
        if (github.context.payload.pull_request) {
            this.pullNumber = github.context.payload.pull_request.number;
        }
        else {
            core.setFailed('Error retrieving PR');
        }
    }
    async copyLabelsFromReferencedIssues() {
        console.log('Adding labels to PR number ', this.pullNumber);
        if (!this.pullNumber) {
            return;
        }
        const pull = await this.client.rest.pulls.get({
            owner: this.owner,
            repo: this.repo,
            pull_number: this.pullNumber,
        });
        const references = this.findReferencedIssues(pull.data.body ?? '');
        console.log('Found these referenced issues: ', references);
        const pullLabels = new Set(pull.data.labels.map((l) => l.name ?? ''));
        const issueLabels = new Set((await Promise.all(references.map((issue) => this.issueLabels(issue)))).flat());
        const newPullLabels = new Set(pullLabels);
        replaceLabels(newPullLabels, this.priorityLabels, this.highestPrioLabel(issueLabels));
        replaceLabels(newPullLabels, this.classificationLabels, this.classification(issueLabels));
        replaceLabels(newPullLabels, this.effortLabels, this.effort(issueLabels));
        const diff = setDiff(pullLabels, newPullLabels);
        console.log('Adding these labels: ', diff.adds);
        console.log('Removing these labels', diff.removes);
        if (isEmptyDiff(diff)) {
            return;
        }
        const dryRun = this.dryRun ? '[--dry-run] ' : '';
        console.log(`${dryRun}${this.pullNumber} (references ${references}) ${vizDiff(diff)}`);
        if (!this.dryRun) {
            await Promise.all([
                diff.adds ? this.client.rest.issues.addLabels({
                    owner: this.owner,
                    repo: this.repo,
                    issue_number: this.pullNumber,
                    labels: diff.adds,
                }) : Promise.resolve(undefined),
                diff.removes ? diff.removes.forEach((label) => this.client.rest.issues.removeLabel({
                    owner: this.owner,
                    repo: this.repo,
                    issue_number: this.pullNumber,
                    name: label,
                })) : Promise.resolve(undefined),
            ]);
        }
    }
    findReferencedIssues(text) {
        const hashRegex = /#(\d+)/g;
        const urlRegex = new RegExp(`https://github.com/${this.owner}/${this.repo}/issues/(\d+)`, 'g');
        const issuesReffedByHash = Array.from(text.matchAll(hashRegex)).map((m) => m[1]);
        const issuesReffedByUrl = Array.from(text.matchAll(urlRegex)).map((m) => m[1]);
        return [...issuesReffedByHash, ...issuesReffedByUrl].map((x) => parseInt(x, 10));
    }
    async issueLabels(issue_number) {
        const issue = await this.client.rest.issues.get({
            owner: this.owner,
            repo: this.repo,
            issue_number,
        });
        return issue.data.labels.map((l) => typeof l === 'string' ? l : l.name ?? '');
    }
    highestPrioLabel(labels) {
        return this.priorityLabels.find(l => labels.has(l));
    }
    classification(labels) {
        return this.classificationLabels.find(l => labels.has(l));
    }
    effort(labels) {
        return this.effortLabels.find(l => labels.has(l));
    }
}
exports.PullRequestLabelManager = PullRequestLabelManager;
function replaceLabels(labels, remove, replace) {
    if (replace !== undefined) {
        for (const r of remove) {
            labels.delete(r);
        }
        labels.add(replace);
    }
}
function setDiff(xs, ys) {
    const ret = { adds: [], removes: [] };
    for (const y of ys) {
        if (!xs.has(y)) {
            ret.adds.push(y);
        }
    }
    for (const x of xs) {
        if (!ys.has(x)) {
            ret.removes.push(x);
        }
    }
    return ret;
}
function isEmptyDiff(diff) {
    return diff.adds.length + diff.removes.length === 0;
}
function vizDiff(diff) {
    return `${JSON.stringify(diff.removes)} -> ${JSON.stringify(diff.adds)}`;
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiY29weS1pc3N1ZS1sYWJlbHMuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi9zcmMvY29weS1pc3N1ZS1sYWJlbHMudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6Ijs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7OztBQUFBLG9EQUFzQztBQUN0Qyx3REFBMEM7QUF3QjFDLE1BQWEsdUJBQXVCO0lBVWxDLFlBQ0UsS0FBYSxFQUNiLE9BQXVDO1FBRXZDLElBQUksQ0FBQyxNQUFNLEdBQUcsTUFBTSxDQUFDLFVBQVUsQ0FBQyxLQUFLLENBQUMsQ0FBQztRQUN2QyxJQUFJLENBQUMsSUFBSSxHQUFHLE1BQU0sQ0FBQyxPQUFPLENBQUMsSUFBSSxDQUFDLElBQUksQ0FBQztRQUNyQyxJQUFJLENBQUMsS0FBSyxHQUFHLE1BQU0sQ0FBQyxPQUFPLENBQUMsSUFBSSxDQUFDLEtBQUssQ0FBQztRQUN2QyxJQUFJLENBQUMsY0FBYyxHQUFHLE9BQU8sQ0FBQyxjQUFjLElBQUksQ0FBQyxJQUFJLEVBQUUsSUFBSSxFQUFFLElBQUksQ0FBQyxDQUFDO1FBQ25FLElBQUksQ0FBQyxvQkFBb0IsR0FBRyxPQUFPLENBQUMsb0JBQW9CLElBQUksQ0FBQyxLQUFLLEVBQUUsaUJBQWlCLENBQUMsQ0FBQztRQUN2RixJQUFJLENBQUMsWUFBWSxHQUFHLE9BQU8sQ0FBQyxZQUFZLElBQUksQ0FBQyxjQUFjLEVBQUUsZUFBZSxFQUFFLGNBQWMsQ0FBQyxDQUFDO1FBQzlGLElBQUksQ0FBQyxNQUFNLEdBQUcsT0FBTyxDQUFDLE1BQU0sSUFBSSxLQUFLLENBQUM7UUFFdEMsSUFBSSxNQUFNLENBQUMsT0FBTyxDQUFDLE9BQU8sQ0FBQyxZQUFZLEVBQUU7WUFDdkMsSUFBSSxDQUFDLFVBQVUsR0FBRyxNQUFNLENBQUMsT0FBTyxDQUFDLE9BQU8sQ0FBQyxZQUFZLENBQUMsTUFBTSxDQUFDO1NBQzlEO2FBQU07WUFDTCxJQUFJLENBQUMsU0FBUyxDQUFDLHFCQUFxQixDQUFDLENBQUM7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QUUsQ0FBQztBQUMzRSxDQUFDIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0ICogYXMgY29yZSBmcm9tICdAYWN0aW9ucy9jb3JlJztcbmltcG9ydCAqIGFzIGdpdGh1YiBmcm9tICdAYWN0aW9ucy9naXRodWInO1xuXG5leHBvcnQgaW50ZXJmYWNlIFB1bGxSZXF1c2V0TGFiZWxNYW5hZ2VyT3B0aW9ucyB7XG4gIC8qKlxuICAgKiBAZGVmYXVsdCAtIFsncDAnLCAncDEnLCAncDInXVxuICAgKi9cbiAgcmVhZG9ubHkgcHJpb3JpdHlMYWJlbHM/OiBzdHJpbmdbXTtcblxuICAvKipcbiAgICogQGRlZmF1bHQgLSBbJ2J1ZycsICdmZWF0dXJlLXJlcXVlc3QnXVxuICAgKi9cbiAgcmVhZG9ubHkgY2xhc3NpZmljYXRpb25MYWJlbHM/OiBzdHJpbmdbXTtcblxuICAvKipcbiAgICogQGRlZmF1bHQgLSBbJ2VmZm9ydC1sYXJnZScsICdlZmZvcnQtbWVkaXVtJywgJ2VmZm9ydC1zbWFsbCddXG4gICAqL1xuICByZWFkb25seSBlZmZvcnRMYWJlbHM/OiBzdHJpbmdbXTtcblxuICAvKipcbiAgICogQGRlZmF1bHQgZmFsc2VcbiAgICovXG4gIHJlYWRvbmx5IGRyeVJ1bj86IGJvb2xlYW47XG59XG5cbmV4cG9ydCBjbGFzcyBQdWxsUmVxdWVzdExhYmVsTWFuYWdlciB7XG4gIHByaXZhdGUgcmVhZG9ubHkgY2xpZW50OiBSZXR1cm5UeXBlPHR5cGVvZiBnaXRodWIuZ2V0T2N0b2tpdD47XG4gIHByaXZhdGUgcmVhZG9ubHkgb3duZXI6IHN0cmluZztcbiAgcHJpdmF0ZSByZWFkb25seSByZXBvOiBzdHJpbmc7XG4gIHByaXZhdGUgcmVhZG9ubHkgcHVsbE51bWJlcjogbnVtYmVyIHwgdW5kZWZpbmVkO1xuICBwcml2YXRlIHJlYWRvbmx5IHByaW9yaXR5TGFiZWxzOiBzdHJpbmdbXTtcbiAgcHJpdmF0ZSByZWFkb25seSBjbGFzc2lmaWNhdGlvbkxhYmVsczogc3RyaW5nW107XG4gIHByaXZhdGUgcmVhZG9ubHkgZWZmb3J0TGFiZWxzOiBzdHJpbmdbXTtcbiAgcHJpdmF0ZSByZWFkb25seSBkcnlSdW46IGJvb2xlYW47XG5cbiAgY29uc3RydWN0b3IoXG4gICAgdG9rZW46IHN0cmluZyxcbiAgICBvcHRpb25zOiBQdWxsUmVxdXNldExhYmVsTWFuYWdlck9wdGlvbnMsXG4gICkge1xuICAgIHRoaXMuY2xpZW50ID0gZ2l0aHViLmdldE9jdG9raXQodG9rZW4pO1xuICAgIHRoaXMucmVwbyA9IGdpdGh1Yi5jb250ZXh0LnJlcG8ucmVwbztcbiAgICB0aGlzLm93bmVyID0gZ2l0aHViLmNvbnRleHQucmVwby5vd25lcjtcbiAgICB0aGlzLnByaW9yaXR5TGFiZWxzID0gb3B0aW9ucy5wcmlvcml0eUxhYmVscyA/PyBbJ3AwJywgJ3AxJywgJ3AyJ107XG4gICAgdGhpcy5jbGFzc2lmaWNhdGlvbkxhYmVscyA9IG9wdGlvbnMuY2xhc3NpZmljYXRpb25MYWJlbHMgPz8gWydidWcnLCAnZmVhdHVyZS1yZXF1ZXN0J107XG4gICAgdGhpcy5lZmZvcnRMYWJlbHMgPSBvcHRpb25zLmVmZm9ydExhYmVscyA/PyBbJ2VmZm9ydC1sYXJnZScsICdlZmZvcnQtbWVkaXVtJywgJ2VmZm9ydC1zbWFsbCddO1xuICAgIHRoaXMuZHJ5UnVuID0gb3B0aW9ucy5kcnlSdW4gPz8gZmFsc2U7XG5cbiAgICBpZiAoZ2l0aHViLmNvbnRleHQucGF5bG9hZC5wdWxsX3JlcXVlc3QpIHtcbiAgICAgIHRoaXMucHVsbE51bWJlciA9IGdpdGh1Yi5jb250ZXh0LnBheWxvYWQucHVsbF9yZXF1ZXN0Lm51bWJlcjtcbiAgICB9IGVsc2Uge1xuICAgICAgY29yZS5zZXRGYWlsZWQoJ0Vycm9yIHJldHJpZXZpbmcgUFInKTtcbiAgICB9XG4gIH1cblxuICBwdWJsaWMgYXN5bmMgY29weUxhYmVsc0Zyb21SZWZlcmVuY2VkSXNzdWVzKCkge1xuICAgIGNvbnNvbGUubG9nKCdBZGRpbmcgbGFiZWxzIHRvIFBSIG51bWJlciAnLCB0aGlzLnB1bGxOdW1iZXIpO1xuICAgIGlmICghdGhpcy5wdWxsTnVtYmVyKSB7XG4gICAgICByZXR1cm47XG4gICAgfVxuXG4gICAgY29uc3QgcHVsbCA9IGF3YWl0IHRoaXMuY2xpZW50LnJlc3QucHVsbHMuZ2V0KHtcbiAgICAgIG93bmVyOiB0aGlzLm93bmVyLFxuICAgICAgcmVwbzogdGhpcy5yZXBvLFxuICAgICAgcHVsbF9udW1iZXI6IHRoaXMucHVsbE51bWJlcixcbiAgICB9KTtcblxuICAgIGNvbnN0IHJlZmVyZW5jZXMgPSB0aGlzLmZpbmRSZWZlcmVuY2VkSXNzdWVzKHB1bGwuZGF0YS5ib2R5ID8/ICcnKTtcbiAgICBjb25zb2xlLmxvZygnRm91bmQgdGhlc2UgcmVmZXJlbmNlZCBpc3N1ZXM6ICcsIHJlZmVyZW5jZXMpO1xuXG4gICAgY29uc3QgcHVsbExhYmVscyA9IG5ldyBTZXQocHVsbC5kYXRhLmxhYmVscy5tYXAoKGwpID0+IGwubmFtZSA/PyAnJykpO1xuICAgIGNvbnN0IGlzc3VlTGFiZWxzID0gbmV3IFNldChcbiAgICAgIChcbiAgICAgICAgYXdhaXQgUHJvbWlzZS5hbGwocmVmZXJlbmNlcy5tYXAoKGlzc3VlKSA9PiB0aGlzLmlzc3VlTGFiZWxzKGlzc3VlKSkpXG4gICAgICApLmZsYXQoKSxcbiAgICApO1xuXG4gICAgY29uc3QgbmV3UHVsbExhYmVscyA9IG5ldyBTZXQocHVsbExhYmVscyk7XG4gICAgcmVwbGFjZUxhYmVscyhuZXdQdWxsTGFiZWxzLCB0aGlzLnByaW9yaXR5TGFiZWxzLCB0aGlzLmhpZ2hlc3RQcmlvTGFiZWwoaXNzdWVMYWJlbHMpKTtcbiAgICByZXBsYWNlTGFiZWxzKG5ld1B1bGxMYWJlbHMsIHRoaXMuY2xhc3NpZmljYXRpb25MYWJlbHMsIHRoaXMuY2xhc3NpZmljYXRpb24oaXNzdWVMYWJlbHMpKTtcbiAgICByZXBsYWNlTGFiZWxzKG5ld1B1bGxMYWJlbHMsIHRoaXMuZWZmb3J0TGFiZWxzLCB0aGlzLmVmZm9ydChpc3N1ZUxhYmVscykpO1xuXG4gICAgY29uc3QgZGlmZiA9IHNldERpZmYocHVsbExhYmVscywgbmV3UHVsbExhYmVscyk7XG4gICAgY29uc29sZS5sb2coJ0FkZGluZyB0aGVzZSBsYWJlbHM6ICcsIGRpZmYuYWRkcyk7XG4gICAgY29uc29sZS5sb2coJ1JlbW92aW5nIHRoZXNlIGxhYmVscycsIGRpZmYucmVtb3Zlcyk7XG5cbiAgICBpZiAoaXNFbXB0eURpZmYoZGlmZikpIHsgcmV0dXJuOyB9XG5cbiAgICBjb25zdCBkcnlSdW4gPSB0aGlzLmRyeVJ1biA/ICdbLS1kcnktcnVuXSAnIDogJyc7XG5cbiAgICBjb25zb2xlLmxvZyhgJHtkcnlSdW59JHt0aGlzLnB1bGxOdW1iZXJ9IChyZWZlcmVuY2VzICR7cmVmZXJlbmNlc30pICR7dml6RGlmZihkaWZmKX1gKTtcbiAgICBpZiAoIXRoaXMuZHJ5UnVuKSB7XG4gICAgICBhd2FpdCBQcm9taXNlLmFsbChbXG4gICAgICAgIGRpZmYuYWRkcyA/IHRoaXMuY2xpZW50LnJlc3QuaXNzdWVzLmFkZExhYmVscyh7XG4gICAgICAgICAgb3duZXI6IHRoaXMub3duZXIsXG4gICAgICAgICAgcmVwbzogdGhpcy5yZXBvLFxuICAgICAgICAgIGlzc3VlX251bWJlcjogdGhpcy5wdWxsTnVtYmVyLFxuICAgICAgICAgIGxhYmVsczogZGlmZi5hZGRzLFxuICAgICAgICB9KSA6IFByb21pc2UucmVzb2x2ZSh1bmRlZmluZWQpLFxuICAgICAgICBkaWZmLnJlbW92ZXMgPyBkaWZmLnJlbW92ZXMuZm9yRWFjaCgobGFiZWwpID0+IHRoaXMuY2xpZW50LnJlc3QuaXNzdWVzLnJlbW92ZUxhYmVsKHtcbiAgICAgICAgICBvd25lcjogdGhpcy5vd25lcixcbiAgICAgICAgICByZXBvOiB0aGlzLnJlcG8sXG4gICAgICAgICAgaXNzdWVfbnVtYmVyOiB0aGlzLnB1bGxOdW1iZXIhLFxuICAgICAgICAgIG5hbWU6IGxhYmVsLFxuICAgICAgICB9KSkgOiBQcm9taXNlLnJlc29sdmUodW5kZWZpbmVkKSxcbiAgICAgIF0pO1xuICAgIH1cbiAgfVxuXG4gIHByaXZhdGUgZmluZFJlZmVyZW5jZWRJc3N1ZXModGV4dDogc3RyaW5nKTogbnVtYmVyW10ge1xuICAgIGNvbnN0IGhhc2hSZWdleCA9IC8jKFxcZCspL2c7XG4gICAgY29uc3QgdXJsUmVnZXggPSBuZXcgUmVnRXhwKGBodHRwczovL2dpdGh1Yi5jb20vJHt0aGlzLm93bmVyfS8ke3RoaXMucmVwb30vaXNzdWVzLyhcXGQrKWAsICdnJyk7XG5cbiAgICBjb25zdCBpc3N1ZXNSZWZmZWRCeUhhc2ggPSBBcnJheS5mcm9tKHRleHQubWF0Y2hBbGwoaGFzaFJlZ2V4KSkubWFwKChtKSA9PiBtWzFdKTtcbiAgICBjb25zdCBpc3N1ZXNSZWZmZWRCeVVybCA9IEFycmF5LmZyb20odGV4dC5tYXRjaEFsbCh1cmxSZWdleCkpLm1hcCgobSkgPT4gbVsxXSk7XG5cbiAgICByZXR1cm4gWy4uLmlzc3Vlc1JlZmZlZEJ5SGFzaCwgLi4uaXNzdWVzUmVmZmVkQnlVcmxdLm1hcCgoeCkgPT4gcGFyc2VJbnQoeCwgMTApKTtcbiAgfVxuXG4gIHByaXZhdGUgYXN5bmMgaXNzdWVMYWJlbHMoaXNzdWVfbnVtYmVyOiBudW1iZXIpOiBQcm9taXNlPHN0cmluZ1tdPiB7XG4gICAgY29uc3QgaXNzdWUgPSBhd2FpdCB0aGlzLmNsaWVudC5yZXN0Lmlzc3Vlcy5nZXQoe1xuICAgICAgb3duZXI6IHRoaXMub3duZXIsXG4gICAgICByZXBvOiB0aGlzLnJlcG8sXG4gICAgICBpc3N1ZV9udW1iZXIsXG4gICAgfSk7XG4gICAgcmV0dXJuIGlzc3VlLmRhdGEubGFiZWxzLm1hcCgobCkgPT4gdHlwZW9mIGwgPT09ICdzdHJpbmcnID8gbCA6IGwubmFtZSA/PyAnJyk7XG4gIH1cblxuICBwcml2YXRlIGhpZ2hlc3RQcmlvTGFiZWwobGFiZWxzOiBTZXQ8c3RyaW5nPikge1xuICAgIHJldHVybiB0aGlzLnByaW9yaXR5TGFiZWxzLmZpbmQobCA9PiBsYWJlbHMuaGFzKGwpKTtcbiAgfVxuXG4gIHByaXZhdGUgY2xhc3NpZmljYXRpb24obGFiZWxzOiBTZXQ8c3RyaW5nPikge1xuICAgIHJldHVybiB0aGlzLmNsYXNzaWZpY2F0aW9uTGFiZWxzLmZpbmQobCA9PiBsYWJlbHMuaGFzKGwpKTtcbiAgfVxuXG4gIHByaXZhdGUgZWZmb3J0KGxhYmVsczogU2V0PHN0cmluZz4pIHtcbiAgICByZXR1cm4gdGhpcy5lZmZvcnRMYWJlbHMuZmluZChsID0+IGxhYmVscy5oYXMobCkpO1xuICB9XG59XG5cbmZ1bmN0aW9uIHJlcGxhY2VMYWJlbHMobGFiZWxzOiBTZXQ8c3RyaW5nPiwgcmVtb3ZlOiBzdHJpbmdbXSwgcmVwbGFjZTogc3RyaW5nIHwgdW5kZWZpbmVkKSB7XG4gIGlmIChyZXBsYWNlICE9PSB1bmRlZmluZWQpIHtcbiAgICBmb3IgKGNvbnN0IHIgb2YgcmVtb3ZlKSB7IGxhYmVscy5kZWxldGUocik7IH1cbiAgICBsYWJlbHMuYWRkKHJlcGxhY2UpO1xuICB9XG59XG5cbmludGVyZmFjZSBTZXREaWZmIHtcbiAgcmVhZG9ubHkgYWRkczogc3RyaW5nW107XG4gIHJlYWRvbmx5IHJlbW92ZXM6IHN0cmluZ1tdO1xufVxuXG5mdW5jdGlvbiBzZXREaWZmKHhzOiBTZXQ8c3RyaW5nPiwgeXM6IFNldDxzdHJpbmc+KTogU2V0RGlmZiB7XG4gIGNvbnN0IHJldDogU2V0RGlmZiA9IHsgYWRkczogW10sIHJlbW92ZXM6IFtdIH07XG4gIGZvciAoY29uc3QgeSBvZiB5cykge1xuICAgIGlmICgheHMuaGFzKHkpKSB7XG4gICAgICByZXQuYWRkcy5wdXNoKHkpO1xuICAgIH1cbiAgfVxuXG4gIGZvciAoY29uc3QgeCBvZiB4cykge1xuICAgIGlmICgheXMuaGFzKHgpKSB7XG4gICAgICByZXQucmVtb3Zlcy5wdXNoKHgpO1xuICAgIH1cbiAgfVxuXG4gIHJldHVybiByZXQ7XG59XG5cbmZ1bmN0aW9uIGlzRW1wdHlEaWZmKGRpZmY6IFNldERpZmYpIHtcbiAgcmV0dXJuIGRpZmYuYWRkcy5sZW5ndGggKyBkaWZmLnJlbW92ZXMubGVuZ3RoID09PSAwO1xufVxuXG5mdW5jdGlvbiB2aXpEaWZmKGRpZmY6IFNldERpZmYpOiBzdHJpbmcge1xuICByZXR1cm4gYCR7SlNPTi5zdHJpbmdpZnkoZGlmZi5yZW1vdmVzKX0gLT4gJHtKU09OLnN0cmluZ2lmeShkaWZmLmFkZHMpfWA7XG59Il19