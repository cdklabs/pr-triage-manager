"use strict";
var __createBinding = (this && this.__createBinding) || (Object.create ? (function(o, m, k, k2) {
    if (k2 === undefined) k2 = k;
    Object.defineProperty(o, k2, { enumerable: true, get: function() { return m[k]; } });
}) : (function(o, m, k, k2) {
    if (k2 === undefined) k2 = k;
    o[k2] = m[k];
}));
var __setModuleDefault = (this && this.__setModuleDefault) || (Object.create ? (function(o, v) {
    Object.defineProperty(o, "default", { enumerable: true, value: v });
}) : function(o, v) {
    o["default"] = v;
});
var __importStar = (this && this.__importStar) || function (mod) {
    if (mod && mod.__esModule) return mod;
    var result = {};
    if (mod != null) for (var k in mod) if (k !== "default" && Object.prototype.hasOwnProperty.call(mod, k)) __createBinding(result, mod, k);
    __setModuleDefault(result, mod);
    return result;
};
Object.defineProperty(exports, "__esModule", { value: true });
exports.PullRequestLabelManager = void 0;
const core = __importStar(require("@actions/core"));
const github = __importStar(require("@actions/github"));
const GITHUB_CLOSE_ISSUE_KEYWORDS = [
    'close',
    'closes',
    'closed',
    'fix',
    'fixes',
    'fixed',
    'resolve',
    'resolves',
    'resolved',
];
class PullRequestLabelManager {
    constructor(token, options) {
        this.client = github.getOctokit(token);
        this.repo = github.context.repo.repo;
        this.owner = github.context.repo.owner;
        this.priorityLabels = options.priorityLabels ?? ['p0', 'p1', 'p2'];
        this.classificationLabels = options.classificationLabels ?? ['bug', 'feature-request'];
        this.effortLabels = options.effortLabels ?? ['effort-large', 'effort-medium', 'effort-small'];
        if (github.context.payload.pull_request) {
            this.pullNumber = github.context.payload.pull_request.number;
        }
        else {
            core.setFailed('Error retrieving PR');
        }
    }
    async copyLabelsFromReferencedIssues() {
        console.log('Adding labels to PR number ', this.pullNumber);
        if (!this.pullNumber) {
            return;
        }
        const pull = await this.client.rest.pulls.get({
            owner: this.owner,
            repo: this.repo,
            pull_number: this.pullNumber,
        });
        const references = this.findReferencedIssues(pull.data.body ?? '');
        console.log('Found these referenced issues: ', references);
        const pullLabels = new Set(pull.data.labels.map((l) => l.name ?? ''));
        const issueLabels = new Set((await Promise.all(references.map((issue) => this.issueLabels(issue)))).flat());
        const newPullLabels = new Set(pullLabels);
        replaceLabels(newPullLabels, this.priorityLabels, this.highestPrioLabel(issueLabels));
        replaceLabels(newPullLabels, this.classificationLabels, this.classification(issueLabels));
        replaceLabels(newPullLabels, this.effortLabels, this.effort(issueLabels));
        const diff = setDiff(pullLabels, newPullLabels);
        console.log('Adding these labels: ', diff.adds);
        console.log('Removing these labels', diff.removes);
        if (isEmptyDiff(diff)) {
            return;
        }
        console.log(`${this.pullNumber} (references ${references}) ${vizDiff(diff)}`);
        await Promise.all([
            diff.adds ? this.client.rest.issues.addLabels({
                owner: this.owner,
                repo: this.repo,
                issue_number: this.pullNumber,
                labels: diff.adds,
            }) : Promise.resolve(undefined),
            diff.removes ? diff.removes.forEach((label) => this.client.rest.issues.removeLabel({
                owner: this.owner,
                repo: this.repo,
                issue_number: this.pullNumber,
                name: label,
            })) : Promise.resolve(undefined),
        ]);
    }
    findReferencedIssues(text) {
        const hashRegex = /(\w+) #(\d+)/g;
        const urlRegex = new RegExp(`(\w+) https://github.com/${this.owner}/${this.repo}/issues/(\d+)`, 'g');
        const issuesClosedByHash = issuesClosed(hashRegex);
        const issuesClosedByUrl = issuesClosed(urlRegex);
        return [...issuesClosedByHash, ...issuesClosedByUrl].map((x) => parseInt(x, 10));
        function issuesClosed(regex) {
            return Array.from(text.matchAll(regex))
                .filter((m) => GITHUB_CLOSE_ISSUE_KEYWORDS.includes(m[1]))
                .map((m) => m[2]);
        }
    }
    async issueLabels(issue_number) {
        const issue = await this.client.rest.issues.get({
            owner: this.owner,
            repo: this.repo,
            issue_number,
        });
        return issue.data.labels.map((l) => typeof l === 'string' ? l : l.name ?? '');
    }
    highestPrioLabel(labels) {
        return this.priorityLabels.find(l => labels.has(l));
    }
    classification(labels) {
        return this.classificationLabels.find(l => labels.has(l));
    }
    effort(labels) {
        return this.effortLabels.find(l => labels.has(l));
    }
}
exports.PullRequestLabelManager = PullRequestLabelManager;
function replaceLabels(labels, remove, replace) {
    if (replace !== undefined) {
        for (const r of remove) {
            labels.delete(r);
        }
        labels.add(replace);
    }
}
function setDiff(xs, ys) {
    const ret = { adds: [], removes: [] };
    for (const y of ys) {
        if (!xs.has(y)) {
            ret.adds.push(y);
        }
    }
    for (const x of xs) {
        if (!ys.has(x)) {
            ret.removes.push(x);
        }
    }
    return ret;
}
function isEmptyDiff(diff) {
    return diff.adds.length + diff.removes.length === 0;
}
function vizDiff(diff) {
    return `${JSON.stringify(diff.removes)} -> ${JSON.stringify(diff.adds)}`;
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiY29weS1pc3N1ZS1sYWJlbHMuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi9zcmMvY29weS1pc3N1ZS1sYWJlbHMudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6Ijs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7OztBQUFBLG9EQUFzQztBQUN0Qyx3REFBMEM7QUFFMUMsTUFBTSwyQkFBMkIsR0FBRztJQUNsQyxPQUFPO0lBQ1AsUUFBUTtJQUNSLFFBQVE7SUFDUixLQUFLO0lBQ0wsT0FBTztJQUNQLE9BQU87SUFDUCxTQUFTO0lBQ1QsVUFBVTtJQUNWLFVBQVU7Q0FDWCxDQUFDO0FBbUJGLE1BQWEsdUJBQXVCO0lBU2xDLFlBQ0UsS0FBYSxFQUNiLE9BQXVDO1FBRXZDLElBQUksQ0FBQyxNQUFNLEdBQUcsTUFBTSxDQUFDLFVBQVUsQ0FBQyxLQUFLLENBQUMsQ0FBQztRQUN2QyxJQUFJLENBQUMsSUFBSSxHQUFHLE1BQU0sQ0FBQyxPQUFPLENBQUMsSUFBSSxDQUFDLElBQUksQ0FBQztRQUNyQyxJQUFJLENBQUMsS0FBSyxHQUFHLE1BQU0sQ0FBQyxPQUFPLENBQUMsSUFBSSxDQUFDLEtBQUssQ0FBQztRQUN2QyxJQUFJLENBQUMsY0FBYyxHQUFHLE9BQU8sQ0FBQyxjQUFjLElBQUksQ0FBQyxJQUFJLEVBQUUsSUFBSSxFQUFFLElBQUksQ0FBQyxDQUFDO1FBQ25FLElBQUksQ0FBQyxvQkFBb0IsR0FBRyxPQUFPLENBQUMsb0JBQW9CLElBQUksQ0FBQyxLQUFLLEVBQUUsaUJBQWlCLENBQUMsQ0FBQztRQUN2RixJQUFJLENBQUMsWUFBWSxHQUFHLE9BQU8sQ0FBQyxZQUFZLElBQUksQ0FBQyxjQUFjLEVBQUUsZUFBZSxFQUFFLGNBQWMsQ0FBQyxDQUFDO1FBRTlGLElBQUksTUFBTSxDQUFDLE9BQU8sQ0FBQyxPQUFPLENBQUMsWUFBWSxFQUFFO1lBQ3ZDLElBQUksQ0FBQyxVQUFVLEdBQUcsTUFBTSxDQUFDLE9BQU8sQ0FBQyxPQUFPLENBQUMsWUFBWSxD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RSxDQUFDO0FBQzNFLENBQUMiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgKiBhcyBjb3JlIGZyb20gJ0BhY3Rpb25zL2NvcmUnO1xuaW1wb3J0ICogYXMgZ2l0aHViIGZyb20gJ0BhY3Rpb25zL2dpdGh1Yic7XG5cbmNvbnN0IEdJVEhVQl9DTE9TRV9JU1NVRV9LRVlXT1JEUyA9IFtcbiAgJ2Nsb3NlJyxcbiAgJ2Nsb3NlcycsXG4gICdjbG9zZWQnLFxuICAnZml4JyxcbiAgJ2ZpeGVzJyxcbiAgJ2ZpeGVkJyxcbiAgJ3Jlc29sdmUnLFxuICAncmVzb2x2ZXMnLFxuICAncmVzb2x2ZWQnLFxuXTtcblxuZXhwb3J0IGludGVyZmFjZSBQdWxsUmVxdXNldExhYmVsTWFuYWdlck9wdGlvbnMge1xuICAvKipcbiAgICogQGRlZmF1bHQgLSBbJ3AwJywgJ3AxJywgJ3AyJ11cbiAgICovXG4gIHJlYWRvbmx5IHByaW9yaXR5TGFiZWxzPzogc3RyaW5nW107XG5cbiAgLyoqXG4gICAqIEBkZWZhdWx0IC0gWydidWcnLCAnZmVhdHVyZS1yZXF1ZXN0J11cbiAgICovXG4gIHJlYWRvbmx5IGNsYXNzaWZpY2F0aW9uTGFiZWxzPzogc3RyaW5nW107XG5cbiAgLyoqXG4gICAqIEBkZWZhdWx0IC0gWydlZmZvcnQtbGFyZ2UnLCAnZWZmb3J0LW1lZGl1bScsICdlZmZvcnQtc21hbGwnXVxuICAgKi9cbiAgcmVhZG9ubHkgZWZmb3J0TGFiZWxzPzogc3RyaW5nW107XG59XG5cbmV4cG9ydCBjbGFzcyBQdWxsUmVxdWVzdExhYmVsTWFuYWdlciB7XG4gIHByaXZhdGUgcmVhZG9ubHkgY2xpZW50OiBSZXR1cm5UeXBlPHR5cGVvZiBnaXRodWIuZ2V0T2N0b2tpdD47XG4gIHByaXZhdGUgcmVhZG9ubHkgb3duZXI6IHN0cmluZztcbiAgcHJpdmF0ZSByZWFkb25seSByZXBvOiBzdHJpbmc7XG4gIHByaXZhdGUgcmVhZG9ubHkgcHVsbE51bWJlcjogbnVtYmVyIHwgdW5kZWZpbmVkO1xuICBwcml2YXRlIHJlYWRvbmx5IHByaW9yaXR5TGFiZWxzOiBzdHJpbmdbXTtcbiAgcHJpdmF0ZSByZWFkb25seSBjbGFzc2lmaWNhdGlvbkxhYmVsczogc3RyaW5nW107XG4gIHByaXZhdGUgcmVhZG9ubHkgZWZmb3J0TGFiZWxzOiBzdHJpbmdbXTtcblxuICBjb25zdHJ1Y3RvcihcbiAgICB0b2tlbjogc3RyaW5nLFxuICAgIG9wdGlvbnM6IFB1bGxSZXF1c2V0TGFiZWxNYW5hZ2VyT3B0aW9ucyxcbiAgKSB7XG4gICAgdGhpcy5jbGllbnQgPSBnaXRodWIuZ2V0T2N0b2tpdCh0b2tlbik7XG4gICAgdGhpcy5yZXBvID0gZ2l0aHViLmNvbnRleHQucmVwby5yZXBvO1xuICAgIHRoaXMub3duZXIgPSBnaXRodWIuY29udGV4dC5yZXBvLm93bmVyO1xuICAgIHRoaXMucHJpb3JpdHlMYWJlbHMgPSBvcHRpb25zLnByaW9yaXR5TGFiZWxzID8/IFsncDAnLCAncDEnLCAncDInXTtcbiAgICB0aGlzLmNsYXNzaWZpY2F0aW9uTGFiZWxzID0gb3B0aW9ucy5jbGFzc2lmaWNhdGlvbkxhYmVscyA/PyBbJ2J1ZycsICdmZWF0dXJlLXJlcXVlc3QnXTtcbiAgICB0aGlzLmVmZm9ydExhYmVscyA9IG9wdGlvbnMuZWZmb3J0TGFiZWxzID8/IFsnZWZmb3J0LWxhcmdlJywgJ2VmZm9ydC1tZWRpdW0nLCAnZWZmb3J0LXNtYWxsJ107XG5cbiAgICBpZiAoZ2l0aHViLmNvbnRleHQucGF5bG9hZC5wdWxsX3JlcXVlc3QpIHtcbiAgICAgIHRoaXMucHVsbE51bWJlciA9IGdpdGh1Yi5jb250ZXh0LnBheWxvYWQucHVsbF9yZXF1ZXN0Lm51bWJlcjtcbiAgICB9IGVsc2Uge1xuICAgICAgY29yZS5zZXRGYWlsZWQoJ0Vycm9yIHJldHJpZXZpbmcgUFInKTtcbiAgICB9XG4gIH1cblxuICBwdWJsaWMgYXN5bmMgY29weUxhYmVsc0Zyb21SZWZlcmVuY2VkSXNzdWVzKCkge1xuICAgIGNvbnNvbGUubG9nKCdBZGRpbmcgbGFiZWxzIHRvIFBSIG51bWJlciAnLCB0aGlzLnB1bGxOdW1iZXIpO1xuICAgIGlmICghdGhpcy5wdWxsTnVtYmVyKSB7XG4gICAgICByZXR1cm47XG4gICAgfVxuXG4gICAgY29uc3QgcHVsbCA9IGF3YWl0IHRoaXMuY2xpZW50LnJlc3QucHVsbHMuZ2V0KHtcbiAgICAgIG93bmVyOiB0aGlzLm93bmVyLFxuICAgICAgcmVwbzogdGhpcy5yZXBvLFxuICAgICAgcHVsbF9udW1iZXI6IHRoaXMucHVsbE51bWJlcixcbiAgICB9KTtcblxuICAgIGNvbnN0IHJlZmVyZW5jZXMgPSB0aGlzLmZpbmRSZWZlcmVuY2VkSXNzdWVzKHB1bGwuZGF0YS5ib2R5ID8/ICcnKTtcbiAgICBjb25zb2xlLmxvZygnRm91bmQgdGhlc2UgcmVmZXJlbmNlZCBpc3N1ZXM6ICcsIHJlZmVyZW5jZXMpO1xuXG4gICAgY29uc3QgcHVsbExhYmVscyA9IG5ldyBTZXQocHVsbC5kYXRhLmxhYmVscy5tYXAoKGwpID0+IGwubmFtZSA/PyAnJykpO1xuICAgIGNvbnN0IGlzc3VlTGFiZWxzID0gbmV3IFNldChcbiAgICAgIChcbiAgICAgICAgYXdhaXQgUHJvbWlzZS5hbGwocmVmZXJlbmNlcy5tYXAoKGlzc3VlKSA9PiB0aGlzLmlzc3VlTGFiZWxzKGlzc3VlKSkpXG4gICAgICApLmZsYXQoKSxcbiAgICApO1xuXG4gICAgY29uc3QgbmV3UHVsbExhYmVscyA9IG5ldyBTZXQocHVsbExhYmVscyk7XG4gICAgcmVwbGFjZUxhYmVscyhuZXdQdWxsTGFiZWxzLCB0aGlzLnByaW9yaXR5TGFiZWxzLCB0aGlzLmhpZ2hlc3RQcmlvTGFiZWwoaXNzdWVMYWJlbHMpKTtcbiAgICByZXBsYWNlTGFiZWxzKG5ld1B1bGxMYWJlbHMsIHRoaXMuY2xhc3NpZmljYXRpb25MYWJlbHMsIHRoaXMuY2xhc3NpZmljYXRpb24oaXNzdWVMYWJlbHMpKTtcbiAgICByZXBsYWNlTGFiZWxzKG5ld1B1bGxMYWJlbHMsIHRoaXMuZWZmb3J0TGFiZWxzLCB0aGlzLmVmZm9ydChpc3N1ZUxhYmVscykpO1xuXG4gICAgY29uc3QgZGlmZiA9IHNldERpZmYocHVsbExhYmVscywgbmV3UHVsbExhYmVscyk7XG4gICAgY29uc29sZS5sb2coJ0FkZGluZyB0aGVzZSBsYWJlbHM6ICcsIGRpZmYuYWRkcyk7XG4gICAgY29uc29sZS5sb2coJ1JlbW92aW5nIHRoZXNlIGxhYmVscycsIGRpZmYucmVtb3Zlcyk7XG5cbiAgICBpZiAoaXNFbXB0eURpZmYoZGlmZikpIHsgcmV0dXJuOyB9XG5cbiAgICBjb25zb2xlLmxvZyhgJHt0aGlzLnB1bGxOdW1iZXJ9IChyZWZlcmVuY2VzICR7cmVmZXJlbmNlc30pICR7dml6RGlmZihkaWZmKX1gKTtcbiAgICBhd2FpdCBQcm9taXNlLmFsbChbXG4gICAgICBkaWZmLmFkZHMgPyB0aGlzLmNsaWVudC5yZXN0Lmlzc3Vlcy5hZGRMYWJlbHMoe1xuICAgICAgICBvd25lcjogdGhpcy5vd25lcixcbiAgICAgICAgcmVwbzogdGhpcy5yZXBvLFxuICAgICAgICBpc3N1ZV9udW1iZXI6IHRoaXMucHVsbE51bWJlcixcbiAgICAgICAgbGFiZWxzOiBkaWZmLmFkZHMsXG4gICAgICB9KSA6IFByb21pc2UucmVzb2x2ZSh1bmRlZmluZWQpLFxuICAgICAgZGlmZi5yZW1vdmVzID8gZGlmZi5yZW1vdmVzLmZvckVhY2goKGxhYmVsKSA9PiB0aGlzLmNsaWVudC5yZXN0Lmlzc3Vlcy5yZW1vdmVMYWJlbCh7XG4gICAgICAgIG93bmVyOiB0aGlzLm93bmVyLFxuICAgICAgICByZXBvOiB0aGlzLnJlcG8sXG4gICAgICAgIGlzc3VlX251bWJlcjogdGhpcy5wdWxsTnVtYmVyISxcbiAgICAgICAgbmFtZTogbGFiZWwsXG4gICAgICB9KSkgOiBQcm9taXNlLnJlc29sdmUodW5kZWZpbmVkKSxcbiAgICBdKTtcbiAgfVxuXG4gIHByaXZhdGUgZmluZFJlZmVyZW5jZWRJc3N1ZXModGV4dDogc3RyaW5nKTogbnVtYmVyW10ge1xuICAgIGNvbnN0IGhhc2hSZWdleCA9IC8oXFx3KykgIyhcXGQrKS9nO1xuICAgIGNvbnN0IHVybFJlZ2V4ID0gbmV3IFJlZ0V4cChgKFxcdyspIGh0dHBzOi8vZ2l0aHViLmNvbS8ke3RoaXMub3duZXJ9LyR7dGhpcy5yZXBvfS9pc3N1ZXMvKFxcZCspYCwgJ2cnKTtcblxuICAgIGNvbnN0IGlzc3Vlc0Nsb3NlZEJ5SGFzaCA9aXNzdWVzQ2xvc2VkKGhhc2hSZWdleCk7XG4gICAgY29uc3QgaXNzdWVzQ2xvc2VkQnlVcmwgPSBpc3N1ZXNDbG9zZWQodXJsUmVnZXgpO1xuXG4gICAgcmV0dXJuIFsuLi5pc3N1ZXNDbG9zZWRCeUhhc2gsIC4uLmlzc3Vlc0Nsb3NlZEJ5VXJsXS5tYXAoKHgpID0+IHBhcnNlSW50KHgsIDEwKSk7XG5cbiAgICBmdW5jdGlvbiBpc3N1ZXNDbG9zZWQocmVnZXg6IFJlZ0V4cCk6IHN0cmluZ1tdIHtcbiAgICAgIHJldHVybiBBcnJheS5mcm9tKHRleHQubWF0Y2hBbGwocmVnZXgpKVxuICAgICAgICAuZmlsdGVyKChtKSA9PiBHSVRIVUJfQ0xPU0VfSVNTVUVfS0VZV09SRFMuaW5jbHVkZXMobVsxXSkpXG4gICAgICAgIC5tYXAoKG0pID0+IG1bMl0pO1xuICAgIH1cbiAgfVxuXG4gIHByaXZhdGUgYXN5bmMgaXNzdWVMYWJlbHMoaXNzdWVfbnVtYmVyOiBudW1iZXIpOiBQcm9taXNlPHN0cmluZ1tdPiB7XG4gICAgY29uc3QgaXNzdWUgPSBhd2FpdCB0aGlzLmNsaWVudC5yZXN0Lmlzc3Vlcy5nZXQoe1xuICAgICAgb3duZXI6IHRoaXMub3duZXIsXG4gICAgICByZXBvOiB0aGlzLnJlcG8sXG4gICAgICBpc3N1ZV9udW1iZXIsXG4gICAgfSk7XG4gICAgcmV0dXJuIGlzc3VlLmRhdGEubGFiZWxzLm1hcCgobCkgPT4gdHlwZW9mIGwgPT09ICdzdHJpbmcnID8gbCA6IGwubmFtZSA/PyAnJyk7XG4gIH1cblxuICBwcml2YXRlIGhpZ2hlc3RQcmlvTGFiZWwobGFiZWxzOiBTZXQ8c3RyaW5nPikge1xuICAgIHJldHVybiB0aGlzLnByaW9yaXR5TGFiZWxzLmZpbmQobCA9PiBsYWJlbHMuaGFzKGwpKTtcbiAgfVxuXG4gIHByaXZhdGUgY2xhc3NpZmljYXRpb24obGFiZWxzOiBTZXQ8c3RyaW5nPikge1xuICAgIHJldHVybiB0aGlzLmNsYXNzaWZpY2F0aW9uTGFiZWxzLmZpbmQobCA9PiBsYWJlbHMuaGFzKGwpKTtcbiAgfVxuXG4gIHByaXZhdGUgZWZmb3J0KGxhYmVsczogU2V0PHN0cmluZz4pIHtcbiAgICByZXR1cm4gdGhpcy5lZmZvcnRMYWJlbHMuZmluZChsID0+IGxhYmVscy5oYXMobCkpO1xuICB9XG59XG5cbmZ1bmN0aW9uIHJlcGxhY2VMYWJlbHMobGFiZWxzOiBTZXQ8c3RyaW5nPiwgcmVtb3ZlOiBzdHJpbmdbXSwgcmVwbGFjZTogc3RyaW5nIHwgdW5kZWZpbmVkKSB7XG4gIGlmIChyZXBsYWNlICE9PSB1bmRlZmluZWQpIHtcbiAgICBmb3IgKGNvbnN0IHIgb2YgcmVtb3ZlKSB7IGxhYmVscy5kZWxldGUocik7IH1cbiAgICBsYWJlbHMuYWRkKHJlcGxhY2UpO1xuICB9XG59XG5cbmludGVyZmFjZSBTZXREaWZmIHtcbiAgcmVhZG9ubHkgYWRkczogc3RyaW5nW107XG4gIHJlYWRvbmx5IHJlbW92ZXM6IHN0cmluZ1tdO1xufVxuXG5mdW5jdGlvbiBzZXREaWZmKHhzOiBTZXQ8c3RyaW5nPiwgeXM6IFNldDxzdHJpbmc+KTogU2V0RGlmZiB7XG4gIGNvbnN0IHJldDogU2V0RGlmZiA9IHsgYWRkczogW10sIHJlbW92ZXM6IFtdIH07XG4gIGZvciAoY29uc3QgeSBvZiB5cykge1xuICAgIGlmICgheHMuaGFzKHkpKSB7XG4gICAgICByZXQuYWRkcy5wdXNoKHkpO1xuICAgIH1cbiAgfVxuXG4gIGZvciAoY29uc3QgeCBvZiB4cykge1xuICAgIGlmICgheXMuaGFzKHgpKSB7XG4gICAgICByZXQucmVtb3Zlcy5wdXNoKHgpO1xuICAgIH1cbiAgfVxuXG4gIHJldHVybiByZXQ7XG59XG5cbmZ1bmN0aW9uIGlzRW1wdHlEaWZmKGRpZmY6IFNldERpZmYpIHtcbiAgcmV0dXJuIGRpZmYuYWRkcy5sZW5ndGggKyBkaWZmLnJlbW92ZXMubGVuZ3RoID09PSAwO1xufVxuXG5mdW5jdGlvbiB2aXpEaWZmKGRpZmY6IFNldERpZmYpOiBzdHJpbmcge1xuICByZXR1cm4gYCR7SlNPTi5zdHJpbmdpZnkoZGlmZi5yZW1vdmVzKX0gLT4gJHtKU09OLnN0cmluZ2lmeShkaWZmLmFkZHMpfWA7XG59Il19